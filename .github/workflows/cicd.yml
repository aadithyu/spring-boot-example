name: CICD

on: push:
      branch: [deploy-to-ec2]
jobs:
    build:
      runs-on: [ubuntu:latest]
      steps:
        - name: Checkout source
          uses: actions/checkout@v3
        - name: Setup Java
          uses: action/setup-java@v3
          with:
            distribution: 'temurin'
            java-version: '17'
        - name: Build Project
          run: mvn clean install -DskipTest
        - name: Login to docker hub
          run: docker login -u ${{secrets.DOCKER_USERNAME}} -P ${{secrets.DOCKER_PASSWORD}}
        - name: Build docker image
          run: docker build -t aadithyuak/springboot-example .
        - name: Publish image to docker hub
          run: docker push aadithyuak/springboot-example:latest 
  
    deploy:
      needs: build
      runs-on: [aws-ec2]
      steps:
        - name: Pull iamge from docker hub
          run: docker pull aadithyuak/springboot-example:latest
        - name: Delete old container
          run: docker rm -f springboot-example-container
        - name: Run Docker container
          run: docker run -d -p 8080:8080 --name springboot-example-container